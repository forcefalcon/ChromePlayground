<!DOCTYPE html>
<html>
  <!--
  Copyright (c) 2012 The Chromium Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can be
  found in the LICENSE file.
  -->
<head>
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="-1" />
  <title>File I/O</title>
  <script type="text/javascript" src="common.js"></script>
  <script type="text/javascript" >
    function loadFile() {
      if (naclModule) {
        var fileName = document.getElementById('file_name').value;

        // Package a message using a simple protocol containing:
        // instruction file_name_length file_name
        var msg = "ld " + fileName.length + " " + fileName;
        naclModule.postMessage(msg);
      }
    }

    function saveFile() {
      if (naclModule) {
        var fileName = document.getElementById('file_name').value;
        var fileText = document.getElementById('file_editor').value;

        // Package a message using a simple protocol containing:
        // instruction file_name_length file_name file_contents
        var msg = "sv " + fileName.length + " " + fileName + " " + fileText;
        naclModule.postMessage(msg);
      }
    }

    function deleteFile() {
      if (naclModule) {
        var fileName = document.getElementById('file_name').value;

        // Package a message using a simple protocol containing:
        // instruction file_name_length file_name
        var msg = "de " + fileName.length + " " + fileName;
        naclModule.postMessage(msg);
      }
    }

    function handleMessage(message_event) {
      var messageParts = message_event.data.split("|", 3);

      if (messageParts[0] == "ERR") {
        updateStatus(messageParts[1]);
        document.getElementById('statusField').style.color = "red";
      }
      else if(messageParts[0] == "STAT") {
        updateStatus(messageParts[1]);
      }
      else if (messageParts[0] == "DISP") {
        // Display the message in the file edit box
        document.getElementById('file_editor').value = messageParts[1];
      }
      else if (messageParts[0] == "READY") {
        var statusField = document.getElementById('statusField');
        updateStatus(statusField.innerHTML + ' Ready!');
      }
    }
  </script>
</head>
<body>

<h1>File I/O</h1>
<h2>Status: <code id="statusField">NO-STATUS</code></h2>
  <!-- The <EMBED> element is wrapped inside a <DIV>, which has both a 'load'
  and a 'message' event listener attached.  This wrapping method is used
  instead of attaching the event listeners directly to the <EMBED> element to
  ensure that the listeners are active before the NaCl module 'load' event
  fires.  This also allows you to use PPB_Messaging.PostMessage() (in C) or
  pp::Instance.PostMessage() (in C++) from within the initialization code in
  your NaCl module. 
  
  The src points to a manifest file, which provides the Native Client plug-in
  a mapping between architecture and NaCl Executable (NEXE). 
  
  We use a non-zero sized embed to give Chrome space to place the bad plug-in
  graphic, if there is a problem.
  -->
  <div id="listener">
    <script type="text/javascript">
      window.webkitStorageInfo.requestQuota(window.PERSISTENT, 1024*1024,
          function(bytes) {
            updateStatus('Allocated '+bytes+' bytes of persistant storage.');
            createNaClModule('file_io', 'newlib', 200, 200);
          },
          function(e) { alert('Failed to allocate space') });
      var listener = document.getElementById('listener')
      listener.addEventListener('load', moduleDidLoad, true);
      listener.addEventListener('message', handleMessage, true);
    </script>
    <textarea id="file_editor"
      cols="40"
      rows="10"
      wrap="hard"
      placeholder="Enter some text to save in a file..."></textarea>
    <br>File Name
    <input type="text" id="file_name" action=""/>
    <button id="save_but" onclick="saveFile()" action="">Save</button>
    <button id="load_but" onclick="loadFile()" action="">Load</button>
    <button id="delete_but" onclick="deleteFile()" action="">Delete</button>
  </div>
</body>
</html>
